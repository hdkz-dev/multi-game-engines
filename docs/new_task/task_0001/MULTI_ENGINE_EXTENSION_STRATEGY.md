# multi-game-engines 拡張検討：多ゲーム対応と汎用アーキテクチャの深化

## 1. 概要

`multi-game-engines` ライブラリを、将棋（やねうらお）だけでなく、チェス、リバーシ、チェッカー、五目並べ等の多様なボードゲームエンジンを包含する「統合思考エンジン・プラットフォーム」として確立するための、不足要素・検討事項・懸念点の洗い出しです。

## 2. 対象ゲームと想定エンジン/プロトコル

| ゲーム         | 想定エンジン例    | 標準プロトコル | 特徴・要調整箇所                                             |
| :------------- | :---------------- | :------------- | :----------------------------------------------------------- |
| **将棋**       | やねうらお, Gikou | USI            | NNUE評価関数（巨大）、合法手生成が複雑。                     |
| **チェス**     | Stockfish, LCZero | UCI            | WASM版が普及しているが、定跡書（Polyglot）の扱いが課題。     |
| **リバーシ**   | Edax, Zebra       | 独自/GTP       | 終盤の完全読み切り性能。評価値が「石差」か「勝率」かの統一。 |
| **五目並べ**   | Renju Solvers     | GTP/独自       | VCF (Victory by Continuous Four) の高速判定ロジック。        |
| **チェッカー** | Chinook-based     | PDN/独自       | データベース参照が主体の思考。                               |

---

## 3. 検討漏れ・不足要素の洗い出し

### A. 定跡書（Opening Books）とデータベースの共通管理

- **課題**: 各ゲームの「定跡」ファイルをどう扱うか。
- **解決案**:
  - エンジンバイナリとは別に `.bin` や `.db` ファイルを独立したアセットとして定義する。
  - `multi-game-engines` に「BookProvider」インターフェースを追加し、IndexedDB または URL 経由でオンデマンドに読み込む。

### B. 評価値の標準化（Normalization）

- **課題**: 将棋は「駒得（数百）」、チェスは「ポーン差（1.00）」、リバーシは「石差」と評価値のスケールがバラバラ。
- **解決案**:
  - `IEngineAdapter` の出力に `score: { raw: number, unit: 'cp' | 'diff' | 'winrate', normalized: number }` を持たせる。
  - `normalized` は -1.0 (負け確) 〜 1.0 (勝ち確) の範囲に変換し、UI (評価バー) の共通化を容易にする。

### C. 思考中断とリソース解放の同時性

- **課題**: `terminate()` だけでは、WASM 内部で確保された巨大なメモリが即座に OS に返却されない場合がある。
- **解決案**:
  - 各アダプターに `destroy()` メソッドを実装し、明示的に `Module._free` や Emscripten の終了処理を呼び出す。
  - ブラウザの `visibilitychange` イベントに連動した、バックグラウンド時のリソース自動節約（スレッド抑制）。

### D. 検討情報の汎用構造化（PV: Principal Variation）

- **課題**: `info string` をパースした際の「読み筋」の形式がゲームごとに異なる。
- **解決案**:
  - `Move` オブジェクトの配列として標準化し、フロントエンド側で各マスの座標に強調表示（ハイライト）を連動させやすくする。

### E. ネイティブ実行（Capacitor/Native）とのハイブリッド化

- **課題**: WASM はブラウザで手軽に動くが、スマホ端末の CPU 性能を 100% 引き出せない（SIMD制約等）。
- **解決案**:
  - 本プロジェクトが Capacitor を使用していることを活かし、`multi-game-engines` を Capacitor プラグインとしてもラップ可能にする。
  - Web版は WASM、アプリ版はネイティブ C++ バイナリを呼び出す透過的な切り替え層。

### F. 巨大アセットの配信戦略（CDN利用）

- **課題**: 全エンジンの WASM と評価関数をバンドルするとアプリサイズが GB 単位になる。
- **解決案**:
  - `AssetRegistry` を実装し、必要な時だけ特定の URL (GitHub Releases 等) から WASM/NNUE を取得する。
  - 整合性チェックのためのハッシュ検証（SRI）の自動化。

---

## 4. 別途懸念点・リスク

### ① WASM の「コールドスタート」問題

- 重重量級エンジン（Stockfish 16+ 等）は、WASM のインスタンス化と NNUE のロードに数秒を要する。
- **対応**: ユーザーが「対局開始」を押す前、ゲーム選択画面で低優先度でプリロードを開始する `backgroundInit()` 機能の導入。

### ② 複数エンジンの競合とメモリ制限 (Jetsam)

- 同時に複数のゲームを開いた場合、メモリ不足（OOM）でタブがクラッシュする。特に iOS Safari は Worker へのメモリ割り当てが非常に厳しい。
- **対応**:
  - シングルトン管理、または「アクティブなエンジンは1つまで」という排他制御ロジックのライブラリ側での実装。
  - デバイスの `deviceMemory` API を参照し、利用可能な RAM に応じてエンジンの `Hash` サイズを自動的に最小化する。

### ③ ライセンス・ミキシング

- MIT, GPL-3.0, Apache-2.0 などが混在する。
- **対応**:
  - エンジンごとに `LICENSE` ファイルを分離し、ライブラリ使用時に各エンジンのライセンスを表示・同意させる仕組み。
  - `multi-game-engines` 自体は MIT とし、ラップするエンジン（GPL等）とは通信プロトコル経由で分離することで、プロジェクト全体のライセンス汚染を防ぐ。

### ④ 解析情報の「評価グラフ」表示の共通化

- **課題**: 棋譜解析時に、過去の全手番の評価値を一括でエンジンに投げるとブラウザがフリーズする。
- **解決案**:
  - 解析用の「BatchQueue」を実装し、1手ずつ非同期で処理しながら UI を更新する。

---

## 5. multi-game-engines 側での調整・最適化済みプロンプト

開発および拡張時には、以下の統合プロンプトガイドを使用して品質を担保してください。

👉 **[最適化済み AI プロンプト集 (OPTIMIZED_AI_PROMPTS.md)](./OPTIMIZED_AI_PROMPTS.md)**

特に以下のプロンプトが多ゲーム拡張に有効です：

- **Prompt 1 & 2**: 新しいゲーム（Edax, KataGo等）のアダプターとドメイン定義。
- **Prompt 3**: 巨大な WASM/NNUE アセットの SRI 管理。
- **Prompt 5**: モノレポ全体の型安全性と品質監査。
