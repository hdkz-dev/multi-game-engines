# エンジン統合検討資料: やねうらお等外部エンジンの活用 (multi-game-engines)

## 1. 概要

`multi-board-games` において、プロレベルの思考強度を持つ外部エンジン（Stockfish, やねうらお等）を統合するための計画案です。これらのエンジンは計算負荷が高く、リソース管理が複雑なため、独立したアダプターライブラリ `multi-game-engines` を通じて管理します。

## 2. 懸念事項・検討事項

### A. パフォーマンスとリソース制限（特に将棋/やねうらお）

- **WASM SIMD/マルチスレッドの利用**:
  - 将棋エンジンはビット演算の塊であり、WASM SIMD (`-msimd128`) が性能を左右します。
  - Web Worker でのマルチスレッド (`SharedArrayBuffer`) 利用は劇的な速度向上をもたらしますが、**COOP/COEPヘッダーの制約**により、ホスティング環境（Vercel, GitHub Pages 等）の設定変更が必要になります。
- **評価関数 (NNUE) のデプロイ**:
  - やねうらおの NNUE ファイル（例: `nn.bin`）は数十MBあります。これを Worker に転送する際のオーバーヘッド、およびモバイル端末でのメモリ圧迫（Jetsamによるキル）が最大の懸念です。

### B. パフォーマンスとブラウザ互換性

- **ビットボード操作の最適化**: 64ビット以上のビット演算を多用する将棋のロジックは、WASM においてネイティブほどの速度が出にくい傾向があります。
- **SharedArrayBuffer の可用性**: モバイル環境では無効化されている場合が多く、シングルスレッドへのフォールバックが必須です。

### C. 通信プロトコルと抽象化

- **USI (Universal Shogi Interface) の完備**:
  - UCI (Chess) と USI (Shogi) は似ていますが、`info` 文字列の形式やオプションが異なります。これらを `multi-game-engines` 内部で `BaseEngineAdapter` として抽象化し、`multi-board-games` 側はプロトコルの差異を意識せずに済むようにします。
- **リアルタイム解析情報のパース**:
  - 思考中の「読み筋 (PV)」「評価値 (cp)」「探索深さ」をリアルタイムに抽出し、UI (EvalBar等) に反映する仕組みが必要です。

### D. 法的・ライセンス事項

- **GPL-3.0 の取り扱い**:
  - やねうらお等は GPL ライセンスです。WASM としてブラウザで実行する場合、動的リンクに近い形態となるため、プロジェクト全体のライセンス形態に注意が必要です（プロトコル通信を介した Worker 分離により、疎結合を保つことが推奨されます）。

---

## 3. multi-game-engines 側で対応・準備すべき内容

| 項目                     | 内容                                                                              | 優先度   |
| :----------------------- | :-------------------------------------------------------------------------------- | :------- |
| **インターフェース定義** | `IEngineAdapter` への USI 拡張、コマンドキューの実装。                            | **最高** |
| **NNUE ローダー**        | HTTP 経由で評価ファイルを部分取得・キャッシュ (IndexedDB) する仕組み。            | **高**   |
| **Build Pipeline**       | Docker を使用した、Emscripten による各エンジンの自動ビルド環境。                  | **中**   |
| **自動設定調整**         | 実行環境の CPU 数・RAM 容量を検知し、`Threads` や `Hash` オプションを自動最適化。 | **高**   |
| **解析パーサー**         | エンジンが出力するテキストストリームを構造化データに変換する正規表現パーサー。    | **中**   |

---

## 4. multi-game-engines 開発用 AI プロンプト

`multi-game-engines` の実装や改善を AI に依頼する際は、以下の最適化されたプロンプト集を使用してください。
これらは 2026 Zenith Tier 基準（型安全、セキュリティ、i18n 分離）に完全に準拠しています。

👉 **[最適化済み AI プロンプト集 (OPTIMIZED_AI_PROMPTS.md)](./OPTIMIZED_AI_PROMPTS.md)**

主要なプロンプトカテゴリ：

- **新規エンジンアダプターの実装**: プロトコル（UCI/USI/GTP）に基づいた拡張。
- **新規ドメインパッケージの作成**: Branded Types による型安全な Move/Position 定義。
- **エンジンレジストリ管理**: SRI ハッシュを含む `engines.json` の更新。
- **UI コンポーネントの実装**: React/Web Components 連携。
- **品質監査と強化**: Zero-Any ポリシーとセキュリティの徹底。

---

## 5. multi-board-games 側での対応

- `useWorkerAI` フックを拡張し、`engineSource: 'local' | 'external'` をサポート。
- 外部エンジンの設定（思考時間、スレッド数等）を保存する `AISettingsStore` への項目追加。
- 棋譜の標準形式 (SFEN/FEN) の、エンジン向けエクスポートロジックの強化。
