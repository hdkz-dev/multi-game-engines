# 類似プロジェクト調査とライセンスアーキテクチャ分析

## 1. 概要

本ドキュメントは、`multi-game-engines` プロジェクトにおけるライセンス分離戦略の妥当性を検証するため、類似するオープンソースプロジェクトのアーキテクチャとライセンス運用事例を調査・分析した結果をまとめたものです。

特に、GPL (General Public License) が適用される強力な将棋・チェスエンジン（Stockfish, やねうら王など）を、MITライセンス等のより緩やかなライセンスを持つWebアプリケーションやライブラリから利用する際の「法的な分離（License Separation）」と「技術的な分離（Technical Separation）」に焦点を当てています。

## 2. 調査対象プロジェクト

### 2.1. Lichess (`lila`, `stockfish.js`)

- **概要**: 世界最大級のオープンソース・チェス対局サイト。
- **ライセンス**:
  - Webフロントエンド (`lila`): **AGPL-3.0** (サーバーサイドを含む全体) / 一部クライアントサイドはMIT
  - エンジン (`Stockfish`): **GPL-3.0**
- **アーキテクチャ**:
  - Webブラウザ上で `stockfish.js` (Wasm/Asm.js) を **Web Worker** として独立したスレッドで実行。
  - メインスレッド（UI）とWorker間は `postMessage` を用いた **UCI (Universal Chess Interface)** プロトコル（テキストベース）で通信。
- **ライセンス分離の考え方**:
  - ブラウザの同一メモリ空間（Origin）内で動作するものの、Workerとして分離され、明確な通信プロトコル（UCI）を介して連携しているため、UIコードがエンジンの「派生物（Derivative Work）」とは見なされない解釈で運用されています。
  - Lichess自体もAGPLであるため親和性は高いですが、MITライセンスのライブラリ（例: `chessops`）も同様の構成でGPLエンジンを利用しています。

### 2.2. Shogi Playground (将棋プレイヤーズ)

- **概要**: ブラウザ上で動作する将棋検討・対局ツール。
- **ライセンス**:
  - アプリケーション: **MIT License**
  - エンジン (`YaneuraOu`): **GPL-3.0**
- **アーキテクチャ**:
  - やねうら王を Emscripten で Wasm 化し、Web Worker 内で実行。
  - USI (Universal Shogi Interface) プロトコルで通信。
- **特記事項**:
  - アプリケーション本体（MIT）とエンジン（GPL）を明確に分離しており、ソースコードのリポジトリも分かれていることが多いです。
  - ユーザーがブラウザ上でエンジンを「ロード」する形式をとることで、配布時のライセンス競合を回避しています。

### 2.3. cm-chessboard / chess.js

- **概要**:
  - `cm-chessboard`: チェス盤UIライブラリ (MIT)
  - `chess.js`: チェスのルールロジックライブラリ (BSD-2-Clause / MIT)
- **アーキテクチャ**:
  - これらは「エンジン（思考ルーチン）」を含まない純粋なUI/ロジックライブラリです。
  - ユーザーが任意のエンジン（Stockfishなど）を別途用意し、Web Worker経由で接続することを前提とした設計になっています。
  - ライブラリ自体にGPLコードが含まれないため、商用利用もしやすいMIT/BSDライセンスを維持しています。

## 3. ライセンス分離のベストプラクティス

WebフロントエンドにおいてGPLエンジンを利用する場合、以下の技術的要件を満たすことで、メインアプリケーションへのGPL汚染（Copyleftの影響）を防ぐのが一般的です。

### 3.1. Web Worker による分離 (Strong Separation)

エンジンをメインスレッド（UIスレッド）と同じスクリプト内にバンドル（静的リンクに相当）せず、**Web Worker** として別スクリプトファイルから起動します。

- **NG (リスク高)**: `import { engine } from 'stockfish-gpl';` して直接関数を呼び出す。
- **OK (推奨)**: `new Worker('stockfish.js')` で外部ファイルとして読み込む。

### 3.2. 通信プロトコルによる疎結合 (Loose Coupling)

エンジンとアプリケーション間のやり取りを、標準化されたテキストプロトコル（UCI, USI）のみに限定します。内部関数やメモリ構造を直接共有・操作しないことで、著作権法上の「プログラムの結合」ではなく「通信による連携」であることを主張できます。

### 3.3. 動的ロード (Dynamic Loading)

エンジン本体（Wasm/JSファイル）をアプリケーションのビルド成果物（bundle.js）に含めず、実行時に **CDN** や別サーバーからフェッチする構成にします。
これにより、アプリケーションの配布物自体にはGPLコードが含まれない状態を保てます。

## 4. `multi-game-engines` の適合性評価

現在の `multi-game-engines` の設計を、上記のベストプラクティスに照らして評価します。

### 評価: ✅ 適合 (License Safe)

1.  **WorkerCommunicator の利用**:
    - `packages/core` および各アダプターは、エンジンを `new Worker(url)` で起動し、`postMessage` で通信する設計になっています。これは **3.1** の要件を満たしています。

2.  **プロトコル変換レイヤー (Adapter Pattern)**:
    - アダプター内部で UCI/USI プロトコルのテキスト解析を行っており、エンジン内部のロジックには依存していません。これは **3.2** の要件を満たしています。

3.  **CDN からの動的ロード**:
    - `StockfishAdapter` の実装を確認したところ、ソースコード内にエンジンのバイナリを含まず、`jsdelivr` などのCDNから実行時にダウンロードする `sources` 設定を持っています。
    - これにより、`@multi-game-engines/adapter-stockfish` パッケージ自体は **MITライセンス** で配布可能です（GPLコードを含まないため）。

### 結論

`multi-game-engines` は、GPLライセンスのエンジンを利用しつつ、ライブラリ自体はMITライセンスで提供可能なアーキテクチャを採用しています。
ただし、利用者が自身のアプリケーションに組み込む際、**「エンジンの実体（Wasmファイル）をどうホスティングするか」** によっては注意が必要です。

## 5. 推奨事項

1.  **アダプターへのライセンス情報の明記**:
    - 各アダプター（`adapter-stockfish`, `adapter-yaneuraou`）の `README` やコード内に、対応するエンジンのライセンス（GPLなど）を明記し、利用者に周知する。（※既に `ILicenseInfo` 型で実装済み）

2.  **エンジンファイルの分離配布**:
    - 将来的にエンジンを自前でホスティングする場合も、npmパッケージに同梱するのではなく、別の静的アセットとして配信するか、ユーザーにURLを指定させる（Dependency Injection）方式を維持することを推奨します。

3.  **ユーザーへのガイドライン提供**:
    - 本ライブラリを使用してアプリケーションを開発するユーザー向けに、「GPLエンジンの利用時は、アプリ全体をGPLにする必要はないが、エンジンファイルの改変・再配布を行う場合はGPLの義務が生じる」旨のガイドラインを提供すると親切です。
