# フェーズ 3 実装計画書: マルチエンジン・アンサンブルと拡張ゲーム対応

## 1. 目的

本計画は、同一ゲームでの複数エンジン同時実行（アンサンブル分析）を実現し、対応ゲームをバックギャモン、チェッカー、シャンチー、ポーカー等へ拡大するための具体的な実装手順を定義します。

## 2. 抽象化戦略

### 2.1. 汎用プロトコルアダプター (Generic Adapters)

特定のエンジン名に依存せず、プロトコル仕様のみを実装したアダプターを導入します。

- **`@multi-game-engines/adapter-uci`**: あらゆるチェスエンジンに対応。
- **`@multi-game-engines/adapter-usi`**: あらゆる将棋エンジンに対応。
- **`@multi-game-engines/adapter-gtp`**: あらゆる囲碁エンジンに対応。

**構成例:**

```typescript
const engine = bridge.getEngine({
  adapter: "uci", // 汎用アダプターを指定
  id: "stockfish-17-beta",
  config: {
    main: "https://.../stockfish.js",
    wasm: "https://.../stockfish.wasm",
    sri: "sha256-...",
  },
});
```

### 2.2. アンサンブル・モニタリング (Ensemble Logic)

`ui-core` に、複数のエンジン状態を統合して扱う `EnsembleMonitor` を導入します。

- **機能**: 複数エンジンの評価値、最善手、NPS を並列して保持・比較。
- **比較アルゴリズム**:
  - **乖離（Disagreement）検知**: 各エンジンの評価値（CP）の標準偏差が閾値（デフォルト: 50cp）を超えた場合に通知。
  - **重み付け統合**: エンジンのバージョンや信頼度に基づき、加重平均による「合意評価値」を算出。
  - **最善手不一致（Best Move Divergence）**: エンジン間で提案する最善手が異なる場合、多数決または最上位エンジンの重みを優先して表示。
- **パフォーマンス管理**: 複数エンジンの同時実行による CPU/メモリ負荷を監視し、ブラウザのメインスレッドを保護するためのスロットリング（`requestAnimationFrame`）と、動的なリソース制限（最大並列プロセス数）を適用。

## 3. 拡張ゲームの対応方針

| ゲーム             | エンジン (候補) | プロトコル   | 技術的焦点 / リスク                                       |
| :----------------- | :-------------- | :----------- | :-------------------------------------------------------- |
| **シャンチー**     | ElephantEye     | UCCI         | 9x10 盤面 / ライセンス: GPL                               |
| **オセロ**         | Edax            | 独自テキスト | 独自プロトコルの仕様化とリバースエンジニアリング          |
| **バックギャモン** | gnubg           | CLI / JSON   | WASM 移植調査（代替案: クラウドリレー） / ライセンス: GPL |
| **ポーカー**       | DeepStack       | JSON         | 混合戦略（GTO）の可視化 / 商用利用・配布制限の確認        |
| **チェッカー**     | KingsRow        | 独自テキスト | 巨大なテーブルベース（エンドゲーム）のロード              |

※ 実装着手前に、各エンジンのライセンス互換性と WASM への移植可能性を最終確認し、リスク評価書を作成すること。

## 4. 実装ロードマップ (Step-by-Step)

### ステップ 1: 汎用アダプター基盤の構築 (Foundation)

- [ ] `packages/core` の `EngineLoader` を拡張し、動的な URL 注入を正式サポート。
- [ ] `adapter-uci` を新規作成し、Stockfish 以外の UCI エンジンでの動作を実証。
- [ ] `adapter-usi` を新規作成し、やねうら王以外の USI エンジン（技巧等）での動作を実証。

### ステップ 2: アンサンブル・ステートの実装 (Logic)

- [ ] `ui-core` に `EnsembleSearchMonitor` を実装。
- [ ] 複数エンジンの `info` を一画面で比較するための Zod スキーマ定義。
- [ ] `requestAnimationFrame` を用いた複数エンジンデータの同時バッチ更新最適化。

### ステップ 3: ボードゲーム・バリエーションの拡大 (Expansion)

- [ ] **Asian Variants**: `adapter-xiangqi` (シャンチー) のプロトタイプ実装。
- [ ] **Board Games**: `adapter-edax` (オセロ) の SRI ハッシュ確定と正式統合。
- [ ] **Puzzle/Resolve**: バックギャモン (gnubg) の WASM 移植調査とアダプター設計。

### ステップ 4: 高度な演算加速と自動化 (Advanced)

- [ ] **WebGPU Integration**: KataGo (囲碁) 等の NN エンジン向け WebGPU 加速の実装。
- [ ] **Build Pipeline**: GitHub Actions によるエンジンの自前 WASM ビルド自動化。
- [ ] **Cloud Relay**:
  - **仕様**: 低スペック端末向けに外部演算サーバーと連携。
  - **セキュリティ**: TLS 1.3+ 必須。相互 TLS (mTLS) またはトークン認証によるアクセス制御。
  - **プライバシー**: 送信データ（局面）の最小化。ユーザーへの明示的な同意取得（Opt-in）と、ログ保存期間の厳密な管理。
  - **可用性**: サーバー障害時のフォールバック（ローカル限定実行）の自動化。

## 5. 品質・セキュリティ基準

- **セキュリティ**:
  - **SRI ハッシュの厳格運用**: 全ての外部リソースに対し、バイナリの完全性を保証。
  - **CSP / Isolation**: Content Security Policy (CSP) と Cross-Origin Isolation (COOP/COEP) の必須適用。
  - **脆弱性スキャン**: 定期的な依存関係のスキャンと、不審なオリジンからのロード遮断。
- **品質・モニタリング**:
  - **Zero-Any Policy**: 100% の型安全性を維持。
  - **パフォーマンス予算**: CPU 使用率 80% 以下、メモリリークゼロを目標に、高頻度 `info` 出力をスロットリング。
  - **観測可能性 (Observability)**: 各エンジンのエラー率、レイテンシー（SLO）、およびリソース使用状況の構造化メトリクス収集。
- **A11y パリティ**:
  - **WCAG 2.2 AA 遵守**: 盤面の座標変換、駒の音声読上げラベル、およびフォーカス管理の完全準拠。
