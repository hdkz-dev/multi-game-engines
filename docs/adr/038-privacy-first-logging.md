# ADR-038: プライバシー保護のためのログ・サニタイズポリシー (Privacy-First Logging)

## 1. コンテキスト (Context)

2026 Zenith Tier Audit において、エンジンのパースエラー発生時に局面データ（FEN, SFEN, JSON 等）をそのまま `console.warn` 等で出力している箇所が特定された。
局面データ自体は公開情報であるが、ユーザーが局面入力フィールドに悪意のあるスクリプトや個人情報（パスワード、機密トークン等）を誤って入力、あるいは故意に流し込んだ場合、それがコンソールログを通じてブラウザ拡張機能やログ収集サービスに漏洩するリスク（PII Leak）がある。

## 2. 意思決定 (Decision)

以下の原則に基づき、ログ出力時のサニタイズを徹底する。

1.  **データ長の制限**: ログに出力する外部入力データは、原則として先頭 20 文字程度に切り詰める（`truncateLog` ユーティリティの使用）。
2.  **型安全なサニタイズ**: `core` パッケージに `truncateLog` ユーティリティを実装し、全パッケージで再利用する。
3.  **Refuse by Exception の徹底**: 不正な入力はログに出力して「理解しようとする」のではなく、最小限の情報とともに早期に例外をスローし、処理を中断する。

## 3. 実装詳細 (Implementation)

`packages/core/src/utils/Sanitizer.ts`:

```typescript
export function truncateLog(value: unknown, maxLength = 20): string {
  // 実装詳細はソースコードを参照
}
```

## 4. 影響 (Consequences)

- **メリット**: 予期せぬ個人情報のログ流出を防止し、セキュリティ監査におけるプライバシー要件を満たす。
- **デメリット**: デバッグ時に局面の全量を確認するには、別途開発者ツールでオブジェクトを直接インスペクトする必要がある（文字列展開前の状態を保持する等）。

## 5. ステータス (Status)

Accepted (2026-02-20)
