# ADR-054: Extreme Robustness and High Coverage Testing Strategy

## ステータス

Proposed (2026-02-28)

## 文脈

プロジェクトが Zenith Tier 基準に到達し、多数のエンジンと環境（Wasm, Native, SSR）をサポートする中で、単なるコードカバレッジ（命令網羅）だけでは本番環境での信頼性を担保できなくなってきた。特に、ネットワーク切断、ストレージ競合、循環参照、パケット分割などの「極限状態」における挙動を物理的に検証する必要がある。

## 意思決定

以下の 4 つの柱からなる「極限堅牢性テスト戦略」を採用する。

1. **ミドルウェア故障の完全絶縁 (Middleware Isolation)**:
   - `EngineFacade` の各ミドルウェア実行を個別の `try-catch` で保護し、テレメトリ等の付加機能のクラッシュがエンジン本体のコア機能（探索）を阻害しないアーキテクチャを強制する。
2. **構造的攻撃の動的防御 (Structural Hardening)**:
   - `ProtocolValidator` に `WeakSet` による循環参照検知を導入。悪意あるネストされた入力によるスタックオーバーフローを構造的に防止する。
3. **ストリーム整合性の物理検証 (Stream Integrity)**:
   - `EngineLoader` において、`Content-Length` と実際に受信したバイト数を厳密に照合。不完全なデータがストレージにキャッシュされることを防ぎ、ネットワークエラー時のレジリエンスを強化する。
4. **極限エッジケースの網羅 (Extreme Case Coverage)**:
   - 目標ラインカバレッジを 98% 以上に設定。SSR 環境での URL オブジェクト欠如、IndexedDB の接続ブロック、Wasm スレッド作成失敗など、モックを用いて全ての実行パスを物理的に実証する。

## 影響

- **メリット**: 「いかなる環境でも不当にクラッシュしない」という究極の信頼性を数学的・物理的に証明できる。
- **デメリット**: テストコードの維持コストが増大し、環境依存の高度なモック技術が必要となる。
- **リスク**: 一部のブラウザ固有挙動（GC 発火タイミング等）は依然として決定論的なテストが困難。
