# ADR-031: 厳格な TypeScript モノレポ構成とプロジェクト参照の導入

## ステータス

承認済み (Accepted)

## コンテキスト

プロジェクトの品質を「Zenith Tier（究極のティア）」に引き上げるため、既存の TypeScript 設定を再評価しました。
モノレポ構成において、大規模なコードベースでも高速なビルドと、実行時の予期せぬエラー（特に `undefined` 関連）を完全に排除する厳格な型安全性が求められていました。

## 決定

以下の施策を実施することを決定しました。

1.  **共通ベース設定 (`tsconfig.base.json`) の導入**:
    - 全パッケージで共有する厳格なルールセットをルートに集約しました。
    - `strict: true` を基本とし、以下の最新の厳格オプションを有効化しました。
      - `noUncheckedIndexedAccess`: 配列やレコードのインデックスアクセス時に `undefined` の可能性を強制的にチェック。
      - `exactOptionalPropertyTypes`: 省略可能なプロパティに明示的に `undefined` を代入することを制限（または許容を明示）。
2.  **TypeScript プロジェクト参照 (Project References) の有効化**:
    - 各パッケージの `tsconfig.json` に `references` を追加し、`composite: true` を設定。
    - パッケージ間の依存関係を明示することで、インクリメンタルビルドの高速化と、境界を越えた型安全性を強化しました。
3.  **ビルド用設定の分離**:
    - `tsup` などの外部ビルダーが `composite` モードと干渉しないよう、ビルド専用の `tsconfig.build.json` を各パッケージに用意しました。

## 影響

- **ポジティブ**:
  - 実行時の `undefined` 起因のバグがビルド時に検出されるようになり、堅牢性が飛躍的に向上。
  - コードベースの規模が拡大しても、プロジェクト参照によりビルドパフォーマンスが最適化される。
- **ネガティブ**:
  - インデックスアクセスに対して `!` や境界チェックが必要になり、テストコードを含めて若干の記述量増加が生じる。
  - 設定ファイルが増加（`tsconfig.build.json`）し、モノレポ管理の複雑さがわずかに増す。

## 代替案

- 単一の巨大な `tsconfig` で管理：パッケージ間の境界が曖昧になり、循環参照や不要な依存関係の温床になるため却下。
- `strict: false` での運用： Zenith Tier の品質基準を満たさないため却下。
