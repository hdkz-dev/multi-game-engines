# ADR-023: Worker 通信におけるメッセージバッファリング

## ステータス

承認済み (2026-02-11)

## コンテキスト

WebWorker (WASM) が `postMessage` に対して極めて高速に応答を返す場合、メインスレッド側で `expectMessage` による解決リスナーの登録が完了する前に応答メッセージが到着してしまうレースコンディションが発生し、Promise が永遠に解決されない（ハングする）リスクが特定されました。

## 決定

`WorkerCommunicator` に「メッセージバッファリング機構」を導入しました。

1. 受信したメッセージが待機中のリスナーによって処理されなかった場合、一時的に内部キュー（`messageBuffer`）に保持します。
2. `expectMessage` が呼び出された際、まずバッファ内を探索し、先行して届いている適合メッセージがあれば即座にそれを返します。
3. バッファサイズには上限（100件）を設け、古いメッセージを破棄することでメモリリークを防止します。

## 結果

- WASM エンジンの高速な初期化応答（`uciok` 等）を確実にキャッチできるようになり、通信の堅牢性が飛躍的に向上しました。
- 非同期的な登録のタイミングに依存しない、決定論的なメッセージングを実現しました。
