# ADR-024: ハンドルベースのライフサイクル管理と共有アダプターの保護

## ステータス

承認済み (Accepted)

## コンテキスト

`EngineBridge` を通じてエンジンを取得する場合、同一の `adapterId` に対して複数の `EngineFacade` (ハンドル) が生成される可能性があります。
これまでの実装では、一つの `EngineFacade` が `dispose()` を呼び出すと、背後で共有されている `IEngineAdapter` インスタンスも破棄 (`terminate`) されてしまい、他のハンドルが動作不能になる問題がありました。

## 決定

`EngineFacade` に「所有権 (Ownership)」の概念を導入し、ハンドルベースのライフサイクル管理を採用します。

1.  **所有権フラグ (`ownsAdapter`)**:
    - `EngineFacade` のコンストラクタに `ownsAdapter: boolean` を追加します。
    - `true` (デフォルト) の場合、Facade の破棄時にアダプターも破棄します。これはスタンドアロンでアダプターを生成する場合に使用します。
    - `false` の場合、Facade は自身のリスナー解除と進行中のタスクの中断のみを行い、アダプター本体の破棄は行いません。

2.  **Bridge による管理**:
    - `EngineBridge` が生成する `EngineFacade` インスタンスには、常に `ownsAdapter: false` を設定します。
    - アダプターの実際の破棄は、`EngineBridge.unregisterAdapter()` または `EngineBridge.dispose()` が呼び出された際に、Bridge が責任を持って行います。

3.  **テレメトリの独立化**:
    - 各 `EngineFacade` は独自のテレメトリリスナーを持ち、アダプターからのイベントを中継しつつ、Facade 固有のエラー（ストリームの切断等）を独立して通知できるようにします。

## 帰結

- **安全性**: 複数の UI コンポーネントが同一エンジンを監視している状況で、一つのコンポーネントが離脱してもエンジン本体が停止しなくなります。
- **一貫性**: ブリッジ経由で取得したリソースはブリッジが管理するという責務の分離が明確になります。
- **柔軟性**: 必要に応じて、特定の Facade だけがエンジンを完全にシャットダウンさせる権限を持つといった拡張も容易になります。
