# ADR-026: プロトコル入力検証の「拒否」への格上げ (Refuse by Exception)

## ステータス

承認済み (2026-02-13)

## コンテキスト

これまで各プロトコルパーサー（UCI/USI/GTP等）では、エンジンコマンドに悪影響を与える制御文字（改行、ヌル文字、セミコロン等）が含まれていた場合、`.replace()` 等でそれらを除去（サニタイズ）する実装となっていました。しかし、このアプローチには以下の問題があります。

1. プロトコル破壊: 意図しない置換により、正当なデータの意味が変わり、エンジンがハングしたり予期せぬ動作をする可能性がある。
2. 不透明性: 開発者が不正な入力を送った際、サニタイズされたことに気づかずデバッグが困難になる。
3. セキュリティ: ブラックリスト方式のサニタイズは漏れが発生しやすく、コマンドインジェクション攻撃を完全に防ぐには不十分な場合がある。

## 意思決定

サニタイズを完全に廃止し、不正な文字を検出した時点で即座に `EngineError` (SECURITY_ERROR) をスローする「例外スローによる拒否 (Refuse by Exception)」方針を採用します。

- 汎用（UCI/USI/Edax）: セミコロンおよび全 ASCII 制御文字（`[\r\n\0;\x01-\x1f\x7f]`）を含む入力を拒否。
- GTP: SGF互換性のため `;` を許容し、全 ASCII 制御文字（`[\r\n\0\x01-\x1f\x7f]`）を拒否。
- Engine ID: 英数字、ハイフン、アンダースコア（`[a-zA-Z0-9-_]`）のみを許容。それ以外の文字を含む ID による登録や取得を拒否。 (2026-02-13 追記)
- エラー時には `remediation` フィールドを通じて具体的な修正方法を利用者に提示する。

## 影響

- **開発体験**: 不正な入力が早期に明示的なエラーとして表面化するため、デバッグ性が向上する。
- **安全性**: 不正な入力がエンジン（Worker）に到達する前に確実に遮断される。
- **一貫性**: 全アダプターで同一のセキュリティポリシーが強制される。
