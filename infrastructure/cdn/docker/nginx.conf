server {
    listen 80;
    server_name engines.multi-game-engines.dev;

    # ルートディレクトリ
    root /usr/share/nginx/html;

    # gzip 圧縮
    gzip on;
    gzip_types application/wasm application/javascript application/json;
    gzip_min_length 1000;

    # エンジンバイナリの配信
    location /v1/ {
        # CORS ヘッダー (GETリクエスト用)
        add_header Access-Control-Allow-Origin '*' always;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept' always;

        # セキュリティヘッダー (CORP)
        add_header Cross-Origin-Resource-Policy cross-origin always;

        # キャッシュ制御 (1年間、イミュータブル)
        add_header Cache-Control "public, max-age=31536000, immutable";

        # Content-Type 設定
        types {
            application/wasm wasm;
            application/javascript js;
            application/json json;
        }

        # OPTIONS リクエスト (CORS プリフライト)
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin '*' always;
            add_header Access-Control-Allow-Methods 'GET, OPTIONS' always;
            add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept' always;
            add_header Access-Control-Max-Age 86400;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    # manifest.json
    location = /manifest.json {
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control "public, max-age=3600";
    }

    # ヘルスチェック
    location /health {
        default_type text/plain;
        return 200 'OK';
    }
}
